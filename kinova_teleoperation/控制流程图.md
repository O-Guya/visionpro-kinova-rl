# Kinova é¥æ“ä½œç³»ç»Ÿ - æ§åˆ¶æµç¨‹å›¾

> **ç”¨å¯è§†åŒ–å›¾è¡¨ç†è§£æ•´ä¸ªç³»ç»Ÿ** ğŸ“Š

---

## ğŸ“Œ ç³»ç»Ÿæ€»è§ˆ

```mermaid
flowchart TB
    subgraph Input["è¾“å…¥è®¾å¤‡"]
        VP[Vision Pro<br/>æ‰‹éƒ¨å§¿æ€]
        GP[Xboxæ‰‹æŸ„<br/>Aé”®/æ‰³æœº]
    end

    subgraph Processing["æ ¸å¿ƒå¤„ç† (20Hz)"]
        RFM[ReferenceFrameManager<br/>åæ ‡å˜æ¢+æ»¤æ³¢]
        IA[InputAggregator<br/>æ‰‹æŸ„å¤„ç†]
        SM[SafetyMonitor<br/>å®‰å…¨æ£€æŸ¥]
        MP[MotionPlanner<br/>IKæ±‚è§£+è½¨è¿¹]
    end

    subgraph Output["è¾“å‡º"]
        RI[RobotInterface<br/>ROS2é€šä¿¡]
        DL[DataLogger<br/>HDF5è®°å½•]
        Robot[Kinova Gen3]
        HDF5[demo_xxx.hdf5]
    end

    VP --> RFM
    GP --> IA
    RFM --> SM
    IA --> SM
    SM --> MP
    MP --> RI
    RI --> Robot
    SM --> DL
    DL --> HDF5

    style Input fill:#e1f5ff
    style Processing fill:#fff4e1
    style Output fill:#e8f5e9
```

---

## ğŸ”„ ä¸»å¾ªç¯è¯¦ç»†æµç¨‹ (20Hz)

```mermaid
flowchart TD
    Start([ä¸»å¾ªç¯å¼€å§‹<br/>æ¯50msæ‰§è¡Œä¸€æ¬¡])

    subgraph Phase1["1ï¸âƒ£ æ„ŸçŸ¥é˜¶æ®µ"]
        GetVP[è·å–Vision Proæ•°æ®<br/>head_pose, hand_pose]
        GetGP[è·å–æ‰‹æŸ„çŠ¶æ€<br/>Aé”®, æ‰³æœºå€¼]
        GetRobot[è·å–æœºå™¨äººçŠ¶æ€<br/>å…³èŠ‚è§’åº¦, æœ«ç«¯ä½å§¿]
        Filter[ReferenceFrameManager<br/>æ»¤æ³¢ + åæ ‡å˜æ¢]

        GetVP --> Filter
        GetGP -.-> Phase1End
        GetRobot -.-> Phase1End
        Filter --> Phase1End[/hand_filtered<br/>gamepad_state<br/>robot_state/]
    end

    subgraph Phase2["2ï¸âƒ£ å®‰å…¨æ£€æŸ¥"]
        SafetyCheck{SafetyMonitor<br/>ç³»ç»Ÿå¥åº·?}
        SafetyFail[hold_position<br/>ä¿æŒå½“å‰ä½ç½®]
        SafetyPass[ç»§ç»­æ‰§è¡Œ]

        SafetyCheck -->|âŒ ä¸å¥åº·| SafetyFail
        SafetyCheck -->|âœ… å¥åº·| SafetyPass
        SafetyFail --> End
    end

    subgraph Phase3["3ï¸âƒ£ æ§åˆ¶é€»è¾‘"]
        ClutchCheck{Aé”®æŒ‰ä¸‹?}
        FirstPress{é¦–æ¬¡æŒ‰ä¸‹?}
        SetAnchor[è®¾ç½®é”šç‚¹<br/>anchor_hand_pose<br/>anchor_robot_pose]
        CalcDelta[è®¡ç®—å¢é‡<br/>delta = hand - anchor]
        Scale[åº”ç”¨ç¼©æ”¾<br/>delta_scaled = delta * scale]
        CalcTarget[è®¡ç®—ç›®æ ‡<br/>target = anchor_robot + delta_scaled]
        Clamp[å®‰å…¨é™åˆ¶<br/>clamp_to_workspace]
        IK[MotionPlanner<br/>solve_ik]
        Traj[ç”Ÿæˆè½¨è¿¹<br/>generate_trajectory]
        SendCmd[å‘é€æŒ‡ä»¤<br/>send_trajectory<br/>send_gripper]
        LogData[DataLogger<br/>log_frame]
        Release[hold_position<br/>åœæ­¢å½•åˆ¶]

        ClutchCheck -->|âœ… æŒ‰ä¸‹| FirstPress
        ClutchCheck -->|âŒ æ¾å¼€| Release
        FirstPress -->|âœ…| SetAnchor
        FirstPress -->|âŒ| CalcDelta
        SetAnchor --> CalcDelta
        CalcDelta --> Scale
        Scale --> CalcTarget
        CalcTarget --> Clamp
        Clamp --> IK
        IK --> Traj
        Traj --> SendCmd
        SendCmd --> LogData
        LogData --> Phase3End
        Release --> Phase3End
    end

    Phase3End[/å¾ªç¯å®Œæˆ/]
    End([ç­‰å¾…ä¸‹ä¸€æ¬¡å¾ªç¯<br/>sleep until 50ms])

    Start --> Phase1
    Phase1 --> Phase2
    Phase2 --> Phase3
    Phase3 --> End
    End --> Start

    style Start fill:#4CAF50,color:#fff
    style End fill:#4CAF50,color:#fff
    style Phase1 fill:#E3F2FD
    style Phase2 fill:#FFF9C4
    style Phase3 fill:#F3E5F5
    style SafetyFail fill:#FFCDD2
    style SafetyPass fill:#C8E6C9
```

---

## ğŸ¯ Clutch (ç¦»åˆ) æœºåˆ¶è¯¦è§£

```mermaid
stateDiagram-v2
    [*] --> Idle: ç³»ç»Ÿå¯åŠ¨

    Idle --> WaitingPress: ç­‰å¾…Aé”®

    WaitingPress --> ClutchEngaged: Aé”®æŒ‰ä¸‹ (clutch_just_pressed)

    state ClutchEngaged {
        [*] --> SaveAnchor
        SaveAnchor --> Tracking: è®°å½•é”šç‚¹
        Tracking --> Tracking: æ‰‹ç§»åŠ¨ â†’ æœºå™¨äººè·Ÿéš
    }

    ClutchEngaged --> ClutchReleased: Aé”®æ¾å¼€

    state ClutchReleased {
        [*] --> HoldPos
        HoldPos: æœºå™¨äººä¿æŒå½“å‰ä½ç½®
        HoldPos --> StopRecord: åœæ­¢å½•åˆ¶
        StopRecord --> SaveHDF5: ä¿å­˜HDF5æ–‡ä»¶
    }

    ClutchReleased --> WaitingPress: å¯ä»¥é‡æ–°æŒ‰Aé”®

    note right of ClutchEngaged
        åœ¨æ­¤çŠ¶æ€:
        - è®¡ç®—ç›¸å¯¹ä½ç§»
        - IKæ±‚è§£
        - å‘é€è½¨è¿¹
        - å½•åˆ¶æ•°æ®
    end note

    note right of ClutchReleased
        åœ¨æ­¤çŠ¶æ€:
        - æœºå™¨äººä¸åŠ¨
        - å¯ä»¥é‡æ–°è°ƒæ•´æ‰‹çš„ä½ç½®
        - æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶
    end note
```

---

## ğŸ” å®‰å…¨ç›‘æ§é€»è¾‘

```mermaid
flowchart TD
    Start([SafetyMonitor<br/>check_system_health])

    Check1{Vision Pro<br/>æ•°æ®å»¶è¿Ÿ < 200ms?}
    Check2{IKæˆåŠŸç‡ > 50%?}
    Check3{å…³èŠ‚è¯¯å·® < 0.2 rad?}
    Check4{åœ¨å·¥ä½œç©ºé—´å†…?}

    Fail[âŒ å®‰å…¨è¿è§„<br/>è¿”å› False]
    Pass[âœ… ç³»ç»Ÿå¥åº·<br/>è¿”å› True]

    Start --> Check1
    Check1 -->|âŒ å¦| Fail
    Check1 -->|âœ… æ˜¯| Check2
    Check2 -->|âŒ å¦| Fail
    Check2 -->|âœ… æ˜¯| Check3
    Check3 -->|âŒ å¦| Fail
    Check3 -->|âœ… æ˜¯| Check4
    Check4 -->|âŒ å¦| Fail
    Check4 -->|âœ… æ˜¯| Pass

    style Fail fill:#FFCDD2
    style Pass fill:#C8E6C9
```

---

## ğŸ¨ åæ ‡å˜æ¢æµç¨‹

```mermaid
flowchart LR
    subgraph VisionPro["Vision Pro è¾“å‡º"]
        Head[å¤´éƒ¨å§¿æ€<br/>T_head_world]
        Hand[æ‰‹éƒ¨å§¿æ€<br/>T_hand_head]
    end

    subgraph Transform["ReferenceFrameManager"]
        Calib[ä¸–ç•Œåæ ‡æ ¡å‡†<br/>T_world_calib]
        Multiply[çŸ©é˜µä¹˜æ³•<br/>T_hand_world =<br/>T_world_calib *<br/>T_head_world *<br/>T_hand_head]
        Extract[æå–ä½ç½®<br/>[x, y, z]]
        Filter[OneEuroFilter<br/>å¹³æ»‘æ»¤æ³¢]
    end

    subgraph Output["è¾“å‡ºåˆ°æ§åˆ¶å™¨"]
        Filtered[hand_filtered<br/>[x, y, z]]
        Velocity[hand_velocity<br/>[vx, vy, vz]]
    end

    Head --> Calib
    Hand --> Calib
    Calib --> Multiply
    Multiply --> Extract
    Extract --> Filter
    Filter --> Filtered
    Filter --> Velocity

    style VisionPro fill:#E1F5FE
    style Transform fill:#FFF3E0
    style Output fill:#E8F5E9
```

---

## ğŸ“ IK æ±‚è§£ä¸è½¨è¿¹ç”Ÿæˆ

```mermaid
flowchart TD
    Input[è¾“å…¥: ç›®æ ‡ä½ç½® + å§¿æ€]

    subgraph IK["IK æ±‚è§£ (MotionPlanner)"]
        Seed[å‡†å¤‡ç§å­å…³èŠ‚è§’åº¦<br/>å½“å‰å…³èŠ‚é…ç½®]
        Solve[KDL IKæ±‚è§£å™¨]
        Success{æ±‚è§£æˆåŠŸ?}
        Joint[å¾—åˆ°ç›®æ ‡å…³èŠ‚è§’åº¦<br/>[j1...j7]]
        Fail[âŒ IKå¤±è´¥<br/>hold_position]
    end

    subgraph Traj["è½¨è¿¹ç”Ÿæˆ"]
        Current[å½“å‰ä½ç½® P0]
        Predict1[é¢„æµ‹ P1 = P0 + V*50ms]
        Predict2[é¢„æµ‹ P2 = P0 + V*100ms]
        Predict3[é¢„æµ‹ P3 = P0 + V*150ms]
        Window[ç”Ÿæˆ3ç‚¹è½¨è¿¹çª—å£]
    end

    Output[JointTrajectory<br/>å‘é€åˆ°æœºå™¨äºº]

    Input --> IK
    Seed --> Solve
    Solve --> Success
    Success -->|âœ…| Joint
    Success -->|âŒ| Fail
    Joint --> Traj
    Current --> Predict1
    Predict1 --> Predict2
    Predict2 --> Predict3
    Predict3 --> Window
    Window --> Output

    style Fail fill:#FFCDD2
    style Output fill:#C8E6C9
```

---

## ğŸ’¾ æ•°æ®è®°å½•æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Main as main_loop
    participant Logger as DataLogger
    participant HDF5 as HDF5æ–‡ä»¶

    User->>Main: æŒ‰ä¸‹Aé”®
    Main->>Logger: start_recording("demo_xxx")
    Logger->>Logger: åˆ›å»ºç¼“å†²åŒº

    loop æ¯ä¸ªæ§åˆ¶å‘¨æœŸ (50ms)
        Main->>Logger: log_frame(robot_state, action)
        Logger->>Logger: æ•°æ®è¿½åŠ åˆ°ç¼“å†²åŒº
    end

    User->>Main: æ¾å¼€Aé”®
    Main->>Logger: stop_recording()
    Logger->>HDF5: å†™å…¥æ‰€æœ‰æ•°æ®
    HDF5-->>Logger: ä¿å­˜æˆåŠŸ
    Logger-->>Main: è¿”å›æ–‡ä»¶è·¯å¾„
    Main->>User: æ˜¾ç¤º "Demonstration saved: xxx.hdf5"
```

---

## ğŸ® æ‰‹æŸ„è¾“å…¥å¤„ç†

```mermaid
flowchart TD
    Device[/dev/input/js0<br/>æ‰‹æŸ„è®¾å¤‡]

    subgraph InputAggregator["InputAggregator"]
        Read[è¯»å–è¾“å…¥äº‹ä»¶]
        Parse{è§£æäº‹ä»¶ç±»å‹}

        subgraph ButtonLogic["æŒ‰é”®é€»è¾‘"]
            EdgeDetect[è¾¹ç¼˜æ£€æµ‹<br/>just_pressed]
            StateUpdate[çŠ¶æ€æ›´æ–°]
        end

        subgraph TriggerLogic["æ‰³æœºé€»è¾‘"]
            Deadband[æ­»åŒºå¤„ç†<br/>< 0.1 â†’ 0]
            Normalize[å½’ä¸€åŒ– 0-1]
        end

        subgraph ScaleLogic["ç¼©æ”¾é€»è¾‘"]
            YPress{Yé”®æŒ‰ä¸‹?}
            Toggle[åˆ‡æ¢æ¨¡å¼]
            Fast[å¿«é€Ÿæ¨¡å¼<br/>1.5x, 1.5x, 1.0x]
            Precise[ç²¾ç¡®æ¨¡å¼<br/>0.5x, 0.5x, 0.5x]
        end
    end

    Output[GamepadState<br/>æ•°æ®ç±»]

    Device --> Read
    Read --> Parse
    Parse -->|æŒ‰é”®| ButtonLogic
    Parse -->|æ‰³æœº| TriggerLogic
    Parse -->|Yé”®| ScaleLogic

    ButtonLogic --> Output
    TriggerLogic --> Output

    YPress -->|âœ…| Toggle
    Toggle --> Fast
    Toggle --> Precise
    Fast --> Output
    Precise --> Output

    style Device fill:#E3F2FD
    style InputAggregator fill:#FFF9C4
    style Output fill:#E8F5E9
```

---

## ğŸš¨ é”™è¯¯å¤„ç†æµç¨‹

```mermaid
flowchart TD
    Start([æ§åˆ¶å¾ªç¯è¿è¡Œä¸­])

    Error1{Vision Pro<br/>è¿æ¥æ–­å¼€?}
    Error2{IKè¿ç»­å¤±è´¥<br/>> 5æ¬¡?}
    Error3{å…³èŠ‚å¡æ­»?}
    Error4{Bé”®æŒ‰ä¸‹?}

    Handle1[æ‰“å°è­¦å‘Š<br/>hold_position<br/>ç­‰å¾…æ¢å¤]
    Handle2[æ‰“å°IKå¤±è´¥<br/>hold_position<br/>ç¦ç”¨æ§åˆ¶]
    Handle3[æ‰“å°å¡æ­»è­¦å‘Š<br/>ç´§æ€¥åœæ­¢]
    Handle4[ç´§æ€¥åœæ­¢<br/>ç³»ç»Ÿå…³é—­]

    Continue[ç»§ç»­å¾ªç¯]
    Shutdown[ç³»ç»Ÿå…³é—­]

    Start --> Error1
    Error1 -->|âœ…| Handle1
    Error1 -->|âŒ| Error2
    Handle1 --> Continue

    Error2 -->|âœ…| Handle2
    Error2 -->|âŒ| Error3
    Handle2 --> Continue

    Error3 -->|âœ…| Handle3
    Error3 -->|âŒ| Error4
    Handle3 --> Shutdown

    Error4 -->|âœ…| Handle4
    Error4 -->|âŒ| Continue
    Handle4 --> Shutdown

    Continue --> Start

    style Handle1 fill:#FFF9C4
    style Handle2 fill:#FFE0B2
    style Handle3 fill:#FFCDD2
    style Handle4 fill:#FFCDD2
    style Shutdown fill:#B71C1C,color:#fff
```

---

## ğŸ”„ æ¨¡å—é—´é€šä¿¡

```mermaid
graph TB
    subgraph "ä¸»å¾ªç¯ (TeleoperationSystem)"
        Main[main_loop.py<br/>_control_iteration]
    end

    subgraph "è¾“å…¥æ¨¡å—"
        VPStream[VisionProStreamer<br/>å¤–éƒ¨ä¾èµ–]
        RFM[ReferenceFrameManager]
        IA[InputAggregator]
    end

    subgraph "å¤„ç†æ¨¡å—"
        SM[SafetyMonitor]
        MP[MotionPlanner]
    end

    subgraph "è¾“å‡ºæ¨¡å—"
        RI[RobotInterface]
        DL[DataLogger]
    end

    VPStream -->|head_pose<br/>hand_pose| RFM
    RFM -->|hand_filtered<br/>hand_velocity| Main
    IA -->|gamepad_state| Main

    Main -->|vision_timestamp<br/>ik_history<br/>joint_error| SM
    SM -->|is_healthy<br/>safe_position| Main

    Main -->|target_pos<br/>target_rot<br/>seed_joints| MP
    MP -->|joint_trajectory| Main

    Main -->|trajectory<br/>gripper_cmd| RI
    RI -->|robot_state| Main

    Main -->|robot_state<br/>action_delta| DL
    DL -.->|demo_xxx.hdf5| FS[(æ–‡ä»¶ç³»ç»Ÿ)]

    style Main fill:#4CAF50,color:#fff
    style VPStream fill:#2196F3,color:#fff
    style FS fill:#9E9E9E,color:#fff
```

---

## â±ï¸ æ—¶åºåˆ†æ (å•ä¸ªæ§åˆ¶å‘¨æœŸ)

```mermaid
gantt
    title å•ä¸ª20Hzæ§åˆ¶å‘¨æœŸ (50ms)
    dateFormat X
    axisFormat %L ms

    section æ„ŸçŸ¥
    Vision Proè·å– :0, 2
    æ‰‹æŸ„è¯»å– :2, 1
    æœºå™¨äººçŠ¶æ€ :3, 2
    åæ ‡å˜æ¢æ»¤æ³¢ :5, 5

    section å†³ç­–
    å®‰å…¨æ£€æŸ¥ :10, 2
    è®¡ç®—ç›®æ ‡ä½ç½® :12, 1
    å·¥ä½œç©ºé—´é™åˆ¶ :13, 1

    section è§„åˆ’
    IKæ±‚è§£ :14, 10
    è½¨è¿¹ç”Ÿæˆ :24, 5

    section æ‰§è¡Œ
    å‘é€æŒ‡ä»¤ :29, 3
    æ•°æ®è®°å½• :32, 5

    section ç­‰å¾…
    Sleep :37, 13
```

**è¯´æ˜**:
- æ€»è€—æ—¶: ~37ms
- å‰©ä½™æ—¶é—´: ~13ms (buffer)
- å¦‚æœè¶…è¿‡50ms â†’ å‡ºç° "Loop overrun" è­¦å‘Š

---

## ğŸ“Š æ•°æ®ç»“æ„å…³ç³»

```mermaid
classDiagram
    class TeleoperationSystem {
        +vision_pro: VisionProStreamer
        +reference_frame_mgr: ReferenceFrameManager
        +input_aggregator: InputAggregator
        +safety_monitor: SafetyMonitor
        +motion_planner: MotionPlanner
        +data_logger: DataLogger
        +robot_interface: RobotInterface
        +run()
        +_control_iteration()
    }

    class ControlState {
        +anchor_hand_pose: ndarray
        +anchor_robot_pose: ndarray
        +is_clutched: bool
        +ik_success_history: deque
    }

    class GamepadState {
        +clutch_pressed: bool
        +clutch_just_pressed: bool
        +trigger_val: float
        +button_y_pressed: bool
        +button_b_pressed: bool
    }

    class RobotState {
        +joints: ndarray (7)
        +velocities: ndarray (7)
        +ee_pose: ndarray (7)
        +gripper_position: float
        +timestamp: float
    }

    TeleoperationSystem --> ControlState
    TeleoperationSystem --> GamepadState
    TeleoperationSystem --> RobotState
```

---

## ğŸ“ æ€»ç»“

é€šè¿‡è¿™äº›æµç¨‹å›¾ï¼Œä½ åº”è¯¥èƒ½æ¸…æ¥šåœ°ç†è§£:

1. **æ•°æ®æµ**: Vision Pro â†’ æ»¤æ³¢ â†’ å®‰å…¨æ£€æŸ¥ â†’ IK â†’ æœºå™¨äºº
2. **æ§åˆ¶æµ**: Aé”®è§¦å‘ â†’ è®¡ç®—å¢é‡ â†’ æ±‚è§£ â†’ æ‰§è¡Œ
3. **å®‰å…¨æµ**: å¤šé‡æ£€æŸ¥ â†’ å¤±è´¥ç«‹å³åœæ­¢
4. **æ—¶åº**: 20Hzä¸»å¾ªç¯ï¼Œæ¯50msä¸€æ¬¡

**æ ¸å¿ƒç†å¿µ**: ç”¨ç›¸å¯¹ä½ç§»æ§åˆ¶ï¼Œé€šè¿‡Clutchæœºåˆ¶å®ç°å®‰å…¨çµæ´»çš„é¥æ“ä½œï¼

---

**æç¤º**: åœ¨GitHubä¸Šè¿™äº›Mermaidå›¾ä¼šè‡ªåŠ¨æ¸²æŸ“æˆå¯è§†åŒ–å›¾è¡¨ï¼
