# Kinova é¥æ“ä½œç³»ç»Ÿ - æ¨¡å—é€ŸæŸ¥è¡¨

> **30ç§’å¿«é€Ÿæ‰¾åˆ°ä½ éœ€è¦çš„ä»£ç ** âš¡

---

## ğŸ“‹ æ¨¡å—åŠŸèƒ½é€ŸæŸ¥

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | æ ¸å¿ƒåŠŸèƒ½ | å…³é”®æ–¹æ³• | ä½•æ—¶ä¿®æ”¹ |
|------|---------|---------|---------|---------|
| **ReferenceFrameManager** | `modules/reference_frame_manager.py` | åæ ‡å˜æ¢ + æ»¤æ³¢ | `get_filtered_hand_pose()` | è°ƒæ•´æ»¤æ³¢å‚æ•°ã€æ”¹å˜åæ ‡ç³» |
| **InputAggregator** | `modules/input_aggregator.py` | æ‰‹æŸ„è¾“å…¥å¤„ç† | `get_state()` | æ›´æ¢æ‰‹æŸ„å‹å·ã€æ”¹å˜æŒ‰é”®æ˜ å°„ |
| **SafetyMonitor** | `modules/safety_monitor.py` | å®‰å…¨ç›‘æ§ | `check_system_health()` | è°ƒæ•´å®‰å…¨é˜ˆå€¼ã€å·¥ä½œç©ºé—´ |
| **MotionPlanner** | `modules/motion_planner.py` | IKæ±‚è§£ + è½¨è¿¹ | `solve_ik()` | æ›´æ¢IKæ±‚è§£å™¨ã€è°ƒè½¨è¿¹å‚æ•° |
| **DataLogger** | `modules/data_logger.py` | æ•°æ®è®°å½• | `log_frame()` | ä¿®æ”¹ä¿å­˜æ ¼å¼ã€å¢åŠ æ•°æ®é¡¹ |
| **RobotInterface** | `modules/robot_interface.py` | ROS2é€šä¿¡ | `send_trajectory()` | æ›´æ¢æœºå™¨äººå‹å·ã€æ”¹topic |

---

## ğŸ” æŒ‰éœ€æ±‚æŸ¥æ‰¾

### æˆ‘æƒ³è°ƒæ•´æœºå™¨äººè¿åŠ¨é€Ÿåº¦/çµæ•åº¦

**ä¿®æ”¹**: `main_loop.py` â†’ ç¬¬ 100-101 è¡Œ

```python
self.scaling_factors = {
    'x': 1.5,  # â† å¢å¤§è¿™ä¸ªå€¼ï¼ŒXæ–¹å‘ç§»åŠ¨æ›´å¿«
    'y': 1.5,  # â† å¢å¤§è¿™ä¸ªå€¼ï¼ŒYæ–¹å‘ç§»åŠ¨æ›´å¿«
    'z': 1.0   # â† å¢å¤§è¿™ä¸ªå€¼ï¼ŒZæ–¹å‘ç§»åŠ¨æ›´å¿«
}
```

**æˆ–è€…**: `modules/input_aggregator.py` â†’ ç¬¬ 57-62 è¡Œ

```python
self.scaling_presets = {
    'fast': {'x': 1.5, 'y': 1.5, 'z': 1.0},      # â† ä¿®æ”¹å¿«é€Ÿæ¨¡å¼
    'precision': {'x': 0.5, 'y': 0.5, 'z': 0.5}  # â† ä¿®æ”¹ç²¾ç¡®æ¨¡å¼
}
```

---

### æˆ‘æƒ³è°ƒæ•´æ‰‹éƒ¨è·Ÿè¸ªçš„å¹³æ»‘åº¦

**ä¿®æ”¹**: `modules/reference_frame_manager.py` â†’ ç¬¬ 53-56 è¡Œ

```python
self.filters = {
    'x': OneEuroFilter(t0, 0.0,
        min_cutoff=1.0,  # â† å‡å°è¿™ä¸ªå€¼ = æ›´å¹³æ»‘ä½†å»¶è¿Ÿæ›´å¤§
        beta=0.05,       # â† å¢å¤§è¿™ä¸ªå€¼ = å¯¹å¿«é€Ÿè¿åŠ¨å“åº”æ›´å¿«
        d_cutoff=1.0
    ),
    ...
}
```

**å‚æ•°è¯´æ˜**:
- `min_cutoff`: 0.5 = å¾ˆå¹³æ»‘ä½†æœ‰å»¶è¿Ÿ | 2.0 = å“åº”å¿«ä½†å¯èƒ½æŠ–åŠ¨
- `beta`: 0.01 = æ…¢é€Ÿè¿åŠ¨ä¼˜å…ˆ | 0.1 = å¿«é€Ÿè¿åŠ¨ä¼˜å…ˆ

---

### æˆ‘æƒ³ä¿®æ”¹å·¥ä½œç©ºé—´èŒƒå›´

**ä¿®æ”¹**: `config/safety_params.yaml` æˆ– `modules/safety_monitor.py` â†’ ç¬¬ 105-120 è¡Œ

```python
self.workspace_limits = {
    'x_min': -0.6,  # â† å·¦ä¾§è¾¹ç•Œ
    'x_max': 0.6,   # â† å³ä¾§è¾¹ç•Œ
    'y_min': -0.6,  # â† å‰ä¾§è¾¹ç•Œ
    'y_max': 0.6,   # â† åä¾§è¾¹ç•Œ
    'z_min': table_height + 0.03,  # â† æœ€ä½é«˜åº¦ï¼ˆæ¡Œé¢+3cmï¼‰
    'z_max': 1.0    # â† æœ€é«˜é«˜åº¦
}
```

**æ³¨æ„**: ä¿®æ”¹ååŠ¡å¿…æµ‹è¯•ï¼Œé¿å…æœºå™¨äººæ’åˆ°æ¡Œå­æˆ–è¶…å‡ºå…³èŠ‚é™ä½ï¼

---

### æˆ‘æƒ³æ›´æ¢æ‰‹æŸ„æŒ‰é”®æ˜ å°„

**ä¿®æ”¹**: `modules/input_aggregator.py` â†’ ç¬¬ 125-149 è¡Œ

```python
def _update_state(self, events):
    for event in events:
        # ä¿®æ”¹è¿™é‡Œçš„æŒ‰é”®æ˜ å°„
        if event.code == 'BTN_SOUTH':      # Aé”®
            self.state.clutch_pressed = bool(event.state)

        elif event.code == 'BTN_NORTH':    # Yé”®
            self.state.button_y_pressed = bool(event.state)

        elif event.code == 'BTN_EAST':     # Bé”®
            self.state.button_b_pressed = bool(event.state)

        elif event.code == 'ABS_RZ':       # å³æ‰³æœº
            self.state.trigger_val = event.state / 255.0
```

**å¸¸è§æŒ‰é”®ä»£ç **:
- `BTN_SOUTH` = Aé”® (Xbox) / Xé”® (PS)
- `BTN_EAST` = Bé”® (Xbox) / Circle (PS)
- `BTN_NORTH` = Yé”® (Xbox) / Triangle (PS)
- `BTN_WEST` = Xé”® (Xbox) / Square (PS)

---

### æˆ‘æƒ³è°ƒæ•´IKæ±‚è§£ç²¾åº¦

**ä¿®æ”¹**: `modules/motion_planner.py` â†’ ç¬¬ 82-96 è¡Œ

```python
# KDL IK æ±‚è§£å™¨åˆå§‹åŒ–
self.ik_solver = PyKDL.ChainIkSolverPos_LMA(
    chain,
    maxiter=500,      # â† å¢å¤§ = æ›´ç²¾ç¡®ä½†æ›´æ…¢
    eps=1e-5,         # â† å‡å° = æ›´ç²¾ç¡®ä½†æ›´æ…¢
    _tau=1e-5
)
```

**æˆ–è€…**: æ¢ç”¨ TracIK (æ›´å¿«æ›´å¯é )

```python
# åœ¨ __init__ ä¸­æ·»åŠ :
from trac_ik_python.trac_ik import IK
self.ik_solver = IK("base_link", "end_effector_link", timeout=0.03)
```

---

### æˆ‘æƒ³ä¿®æ”¹æ§åˆ¶é¢‘ç‡

**ä¿®æ”¹**: `main_loop.py` â†’ ç¬¬ 85-86 è¡Œ

```python
self.control_rate_hz = 20.0  # â† æ”¹æˆ 50.0 = æ›´å¿«å“åº”ï¼ˆéœ€è¦æ›´å¼ºCPUï¼‰
self.control_period = 1.0 / self.control_rate_hz
```

**è­¦å‘Š**:
- æé«˜é¢‘ç‡éœ€è¦æ›´å¼ºçš„è®¡ç®—èƒ½åŠ›
- å»ºè®®å…ˆåœ¨ä»¿çœŸæ¨¡å¼æµ‹è¯• (`--sim`)
- ç›‘æ§æ˜¯å¦å‡ºç° "Loop overrun" è­¦å‘Š

---

### æˆ‘æƒ³æ›´æ¢Vision Pro IPåœ°å€

**ä¿®æ”¹**: å¯åŠ¨å‘½ä»¤è¡Œå‚æ•°

```bash
python3 -m kinova_teleoperation.main_loop \
    --vision-pro-ip 192.168.1.XXX  # â† æ”¹è¿™é‡Œ
```

**æˆ–è€…**: `config/robot_config.yaml`

```yaml
vision_pro:
  ip: "192.168.1.XXX"  # â† æ”¹è¿™é‡Œ
```

---

### æˆ‘æƒ³ä¿®æ”¹æ•°æ®ä¿å­˜æ ¼å¼

**ä¿®æ”¹**: `modules/data_logger.py` â†’ ç¬¬ 140-180 è¡Œ

```python
def stop_recording(self):
    # ä¿®æ”¹è¿™é‡Œçš„ HDF5 æ•°æ®ç»“æ„
    obs_group = f.create_group('observations')
    obs_group.create_dataset('qpos', data=qpos_array)
    obs_group.create_dataset('qvel', data=qvel_array)
    # â† åœ¨è¿™é‡Œæ·»åŠ æ–°çš„æ•°æ®é¡¹
    obs_group.create_dataset('my_new_data', data=my_array)
```

---

### æˆ‘æƒ³æ·»åŠ ç›¸æœºè§‚æµ‹

**æ­¥éª¤**:

1. **ä¿®æ”¹ DataLogger** (`modules/data_logger.py`)
   ```python
   def log_frame(self, robot_state, action_delta, image=None):  # â† æ·»åŠ  image å‚æ•°
       self.buffer['images'].append(image)
   ```

2. **ä¿®æ”¹ main_loop** (`main_loop.py` â†’ ç¬¬ 372-383 è¡Œ)
   ```python
   # åœ¨è¿™é‡Œæ·»åŠ ç›¸æœºè¯»å–
   camera_image = self.camera.get_image()  # ä½ çš„ç›¸æœºæ¥å£

   self.data_logger.log_frame(
       robot_state=robot_state,
       action_delta=delta_scaled,
       image=camera_image  # â† ä¼ å…¥å›¾åƒ
   )
   ```

---

### æˆ‘æƒ³ç¦ç”¨è½¨è¿¹é¢„æµ‹

**ä¿®æ”¹**: `main_loop.py` â†’ ç¬¬ 350-355 è¡Œ

```python
trajectory = self.motion_planner.generate_trajectory_window(
    joint_target,
    hand_velocity,
    robot_state['joints'],
    use_extrapolation=False  # â† æ”¹æˆ False
)
```

**æ•ˆæœ**: æœºå™¨äººä¸ä¼šé¢„æµ‹æœªæ¥ä½ç½®ï¼Œåªè·Ÿè¸ªå½“å‰ç›®æ ‡

---

### æˆ‘æƒ³æ·»åŠ æŒ¯åŠ¨åé¦ˆ

**æ­¥éª¤**:

1. **åœ¨ InputAggregator ä¸­æ·»åŠ æŒ¯åŠ¨æ–¹æ³•** (`modules/input_aggregator.py`)
   ```python
   def vibrate(self, duration=0.1, strength=1.0):
       # ä½¿ç”¨ Linux evdev å‘é€æŒ¯åŠ¨æŒ‡ä»¤
       pass
   ```

2. **åœ¨å…³é”®äº‹ä»¶æ—¶è°ƒç”¨** (`main_loop.py`)
   ```python
   if gamepad_state.clutch_just_pressed:
       self.input_aggregator.vibrate(duration=0.1)  # â† ç¦»åˆå™¨æ¥åˆæ—¶éœ‡åŠ¨

   if not system_healthy:
       self.input_aggregator.vibrate(duration=0.5, strength=0.5)  # â† å®‰å…¨è­¦å‘Šæ—¶é•¿éœ‡åŠ¨
   ```

---

### æˆ‘æƒ³æ¢æˆ Kinova Gen2

**ä¸»è¦ä¿®æ”¹**:

1. **æœºå™¨äººå‹å·**: ç¡®è®¤ Gen2 ä½¿ç”¨ä¸åŒçš„ ROS é©±åŠ¨ (kinova-ros)
2. **å…³èŠ‚æ•°é‡**: Gen2 ä¹Ÿæ˜¯ 7DOFï¼Œä»£ç æ— éœ€å¤§æ”¹
3. **URDFè·¯å¾„**: æŒ‡å‘ Gen2 çš„ URDF æ–‡ä»¶
4. **Topicåç§°**: å¯èƒ½éœ€è¦ä¿®æ”¹ topic åç§°

**å»ºè®®**: å‚è€ƒ `kinova_data_collection` çš„å®ç°ï¼

---

## ğŸ› å¸¸è§é—®é¢˜å®šä½

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | æ£€æŸ¥ä½ç½® |
|---------|---------|---------|
| æœºå™¨äººä¸åŠ¨ | ROS2è¿æ¥å¤±è´¥ | `modules/robot_interface.py` â†’ `is_ready()` |
| æ‰‹éƒ¨æŠ–åŠ¨ä¸¥é‡ | æ»¤æ³¢å‚æ•°å¤ªå¤§ | `modules/reference_frame_manager.py` â†’ æ»¤æ³¢å™¨å‚æ•° |
| IKç»å¸¸å¤±è´¥ | ç›®æ ‡ä¸å¯è¾¾ | `modules/safety_monitor.py` â†’ å·¥ä½œç©ºé—´é™åˆ¶ |
| ç³»ç»Ÿå»¶è¿Ÿå¤§ | æ§åˆ¶é¢‘ç‡å¤ªé«˜ | `main_loop.py` â†’ `control_rate_hz` |
| å½•åˆ¶æ•°æ®ä¸ºç©º | Clutchæœªè§¦å‘ | `main_loop.py` â†’ ç¬¬ 374-377 è¡Œ |
| æ‰‹æŸ„æ— å“åº” | è®¾å¤‡è·¯å¾„é”™è¯¯ | `modules/input_aggregator.py` â†’ ç¬¬ 118-122 è¡Œ |

---

## ğŸ“Š æ•°æ®æµå‘å›¾

```
Vision Pro (20Hz)
    â†“
ReferenceFrameManager  â† æ»¤æ³¢ + åæ ‡å˜æ¢
    â†“
main_loop._control_iteration()
    â†“
SafetyMonitor  â† æ£€æŸ¥ç³»ç»Ÿå¥åº·
    â†“
MotionPlanner  â† IK æ±‚è§£
    â†“
RobotInterface  â† å‘é€æŒ‡ä»¤
    â†“
Kinova Gen3 (Robot)

åŒæ—¶:
InputAggregator â†’ main_loop â†’ DataLogger â†’ HDF5æ–‡ä»¶
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å¦‚æœå‡ºç° "Loop overrun" è­¦å‘Š:

1. **é™ä½æ§åˆ¶é¢‘ç‡**: `20Hz â†’ 15Hz`
2. **ç¦ç”¨è½¨è¿¹é¢„æµ‹**: `use_extrapolation=False`
3. **å…³é—­æ•°æ®è®°å½•**: `--no-logging`
4. **ç®€åŒ–IK**: å‡å°‘ `maxiter` å‚æ•°

### å¦‚æœæœºå™¨äººå“åº”æ…¢:

1. **æé«˜æ§åˆ¶é¢‘ç‡**: `20Hz â†’ 30Hz`
2. **å¯ç”¨è½¨è¿¹é¢„æµ‹**: `use_extrapolation=True`
3. **è°ƒæ•´æ»¤æ³¢å‚æ•°**: å¢å¤§ `min_cutoff`

### å¦‚æœæ‰‹éƒ¨è·Ÿè¸ªä¸ç¨³å®š:

1. **å¢å¼ºæ»¤æ³¢**: å‡å° `min_cutoff`
2. **è°ƒæ•´ beta**: æ”¹ä¸º `0.02`
3. **æ£€æŸ¥ Vision Pro æ•°æ®è´¨é‡**

---

## ğŸ“ ä»£ç ç‰‡æ®µé€ŸæŸ¥

### è·å–å½“å‰æœºå™¨äººçŠ¶æ€

```python
state = self.robot_interface.get_state()
joints = state['joints']        # 7ä¸ªå…³èŠ‚è§’åº¦
ee_pose = state['ee_pose']      # æœ«ç«¯ä½å§¿ [x,y,z,qx,qy,qz,qw]
gripper = state['gripper_position']  # å¤¹çˆªçŠ¶æ€ 0-1
```

### å‘é€æ§åˆ¶æŒ‡ä»¤

```python
# æ–¹æ³•1: å‘é€è½¨è¿¹
trajectory = JointTrajectory()
# ... å¡«å……è½¨è¿¹æ•°æ®
self.robot_interface.send_trajectory(trajectory)

# æ–¹æ³•2: ä¿æŒå½“å‰ä½ç½®
self.robot_interface.hold_position()

# æ–¹æ³•3: æ§åˆ¶å¤¹çˆª
self.robot_interface.send_gripper(0.5)  # 0=å¼€ 1=å…³
```

### è¯»å–æ‰‹æŸ„çŠ¶æ€

```python
gamepad_state = self.input_aggregator.get_state()

if gamepad_state.clutch_just_pressed:
    print("Aé”®åˆšæŒ‰ä¸‹")

if gamepad_state.button_y_just_pressed:
    print("Yé”®åˆšæŒ‰ä¸‹")

trigger_value = gamepad_state.trigger_val  # 0.0 åˆ° 1.0
```

### æ£€æŸ¥å®‰å…¨çŠ¶æ€

```python
is_safe = self.safety_monitor.check_system_health(
    vision_timestamp=timestamp,
    ik_success_history=history,
    joint_error=error
)

if not is_safe:
    reason = self.safety_monitor.get_violation_reason()
    print(f"å®‰å…¨è¿è§„: {reason}")
```

---

## ğŸ¯ å•å…ƒæµ‹è¯•å‘½ä»¤

```bash
# æµ‹è¯•å„ä¸ªæ¨¡å—
python3 -m kinova_teleoperation.modules.reference_frame_manager
python3 -m kinova_teleoperation.modules.input_aggregator
python3 -m kinova_teleoperation.modules.safety_monitor
python3 -m kinova_teleoperation.modules.motion_planner
python3 -m kinova_teleoperation.modules.data_logger
python3 -m kinova_teleoperation.modules.robot_interface

# é›†æˆæµ‹è¯•
python3 tests/test_integration.py

# ä»¿çœŸæ¨¡å¼æµ‹è¯•
python3 -m kinova_teleoperation.main_loop --sim --no-logging
```

---

## ğŸ“š æ‰©å±•é˜…è¯»

- **å®Œæ•´æ¶æ„**: `æ¶æ„è¯´æ˜.md`
- **è‹±æ–‡æ–‡æ¡£**: `README.md`
- **å¿«é€Ÿå¼€å§‹**: `QUICKSTART.md`

---

**æç¤º**: ä¿®æ”¹ä»£ç å‰å»ºè®®å…ˆå¤‡ä»½ï¼Œå¹¶åœ¨ä»¿çœŸæ¨¡å¼æµ‹è¯•ï¼
